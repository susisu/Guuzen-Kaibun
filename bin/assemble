#!/usr/bin/env node

/*
 * copyright (c) 2015 Susisu
 */

"use strict";

var fs = require("fs");
var palindrome = require("palindrome");
var packageInfo = require("../package.json");

var program = require("commander");

program.version(packageInfo.version, "-v, --version");

program
    .arguments("<dir> <outfile>")
    .action(function (dirname, outfilename) {
        fs.readdir(dirname, function (err, files) {
            if (err) {
                process.stderr.write(err.toString() + "\n");
                process.exit(1);
                return;
            }
            var list = [];
            // 重複数
            var duplNum = Object.create(null);
            // ディレクトリ内のファイルを読み込む
            for (var i = 0; i < files.length; i++) {
                var content = fs.readFileSync(dirname + "/" + files[i], { "encoding": "utf8" });
                var lines   = content.split("\n");
                for (var j = 0; j < lines.length; j++) {
                    if (lines[j] === "") {
                        continue;
                    }
                    var info = lines[j].split("\t");
                    // 重複していたら除く
                    if (duplNum[info[0]]) {
                        duplNum[info[0]]++;
                        continue;
                    }
                    else {
                        duplNum[info[0]] = 1;
                    }
                    // 音数を数値に変換
                    info[2] = parseInt(info[2]);
                    list.push(info);
                }
            }
            // 音数で降順にソート
            list.sort(function (x, y) {
                return y[2] - x[2];
            });
            var counts = [];
            var output = "";
            for (i = 0; i < list.length; i++) {
                if (counts[list[i][2]] === undefined) {
                    counts[list[i][2]] = 1;
                }
                else {
                    counts[list[i][2]]++;
                }
                // 回文、音数、ページ名、ファイル名
                output +=
                    list[i][0] + "\t" +
                    list[i][1] + "\t" +
                    list[i][2].toString() + "\t" +
                    list[i][3] + "\t" +
                    list[i][4] + "\n";
            }
            for (i = 0; i < counts.length; i++) {
                if (!counts[i]) {
                    counts[i] = 0;
                }
                process.stdout.write(i.toString() + "\t" + counts[i].toString() + "\n");
            }
            fs.writeFileSync(outfilename, output);
        })
    });

program.parse(process.argv);

if (program.args.length === 0) {
    program.help();
}
